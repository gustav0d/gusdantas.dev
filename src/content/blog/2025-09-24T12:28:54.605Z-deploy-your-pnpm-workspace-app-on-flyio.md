---
slug: 'deploy-your-pnpm-workspace-app-on-flyio'
title: 'Deploy your pnpm workspace app on Fly.io'
pubDate: 2025-09-24T12:28:54.605Z
draft: true
tags:
  - nodejs
  - ci-cd
---

```bash
flyctl deploy --remote-only --dockerfile ./apps/server/Dockerfile --config ./apps/server/fly.toml
```

Dockerfile

```dockerfile
# syntax = docker/dockerfile:1

# Build stage
ARG NODE_VERSION=22.18.0
FROM node:${NODE_VERSION}-slim AS builder

LABEL fly_launch_runtime="NodeJS"

WORKDIR /app

# Install pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

# Install packages needed to build node modules
RUN apt-get update -qq && \
  apt-get install -y python-is-python3 pkg-config build-essential

# Set up monorepo structure
WORKDIR /app

# Copy the root workspace files
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml* ./

# Copy the packages/types package
COPY packages/types ./packages/types/

# Copy the server package
COPY apps/server ./apps/server/

# Install dependencies for the entire monorepo
RUN pnpm install --frozen-lockfile

# Build the server
RUN pnpm --filter="@fazedor-ia/server" run build

# Production stage
FROM node:${NODE_VERSION}-slim AS production

WORKDIR /app

# Copy built files from builder
COPY --from=builder /app/apps/server/dist /app/apps/server/dist
COPY --from=builder /app/apps/server/package.json /app/apps/server/package.json
COPY --from=builder /app/packages/types /app/packages/types

# Copy production node_modules
COPY --from=builder /app/node_modules /app/node_modules
COPY --from=builder /app/apps/server/node_modules /app/apps/server/node_modules

# Environment variables
ENV NODE_ENV production
ENV PORT 8080

EXPOSE 8080
CMD ["node", "apps/server/dist/server.js"]
```

CI CD

```yaml
# See https://fly.io/docs/app-guides/continuous-deployment-with-github-actions/

name: Fly Deploy
on:
  push:
    branches:
      - main
jobs:
  deploy:
    name: Deploy app
    runs-on: ubuntu-latest
    concurrency: deploy-group    # optional: ensure only one action runs at a time
    steps:
      - uses: actions/checkout@v4
      - uses: superfly/flyctl-actions/setup-flyctl@master
      - run: flyctl deploy --remote-only --dockerfile ./apps/server/Dockerfile --config ./apps/server/fly.toml
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
```
